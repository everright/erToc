/*
 * Plugin Name: erToc plugin for jQuery
 * Version: 0.1.1
 * Author: everright.chen
 * Email: everright.chen@gmail.com
 * Website: http://everright.cn
 * Testd on: jQuery 1.4+, IE 6+, Firefox, Chrome, Safari, Oprea
 * erToc is a jQuery plugin that will automatically generate a table of contents for your page.
 */
!function(a){"use strict";a.erToc=function(b,c){var d=this;d.$this=a(b),d.init=function(){var b,e;d.options=a.extend({},a.erToc.defaults,c),b=d.options.nodes.length,b&&(d.nodeNum=a("body").data(d.options.nodeNumKey)||1,d.currentLevel=d.currentOriLevel=d.currentOriMinLevel=0,d.tiered=d.tieredList(),d.toc="",d.options.startLevel!==parseInt(d.options.startLevel,10)?d.options.startLevel=a.inArray(d.options.startLevel,d.options.nodes):d.options.startLevel-=1,(!d.options.startLevel||0>d.options.startLevel)&&(d.options.startLevel=0),d.options.maxLevel!==parseInt(d.options.maxLevel,10)&&(d.options.maxLevel=a.inArray(d.options.maxLevel,d.options.nodes)+1),(!d.options.maxLevel||d.options.maxLevel<d.options.startLevel)&&(d.options.maxLevel=d.options.nodes.length),e=b-d.options.startLevel,(d.options.startLevel>d.options.maxLevel||e<d.options.maxLevel)&&(d.options.maxLevel=e),d.initNodes()&&(d.initToc(),d.createToc(),(d.options.goTop||d.options.tocScroll)&&(d.$body=window.opera?"CSS1Compat"===document.compatMode?a("html"):a("body"):a("html, body")),!1!==d.options.goTop&&(d.$topNode=a(d.options.goTopNode),d.$topNode.length||(d.$topNode=a("body")),d.options.goTopNodes=d.options.goTopNodes||"auto","auto"===d.options.goTopNodes&&d.$topNode.data("isGoTopPosition","yes"),d.addGoTop())))},d.initNodes=function(){var b,c,e,f,g,a=[];for(b=0,c=d.options.nodes.length;c>b;b++)a[b]=d.options.nodes[b];if(f=a.splice(d.options.startLevel,d.options.maxLevel),d.$nodes=d.$this.find(f.join(", ")),!d.$nodes.length||d.options.nodeMin>0&&d.$nodes.length<d.options.nodeMin)return!1;d.options.nodeMax>0&&(d.$nodes=d.$nodes.filter(":lt("+d.options.nodeMax+")")),d.nodes={ids:[],classes:[],sorts:{ids:{},classes:{}}};for(g in f)"."===f[g].substring(0,1)?(e=f[g].substring(1),d.nodes.classes.push(e),d.nodes.sorts.classes[e]=g):(e=f[g].toLowerCase(),d.nodes.ids.push(e),d.nodes.sorts.ids[e]=g);return!0},d.initToc=function(){var b,c,e,f,g,h,i,j,k;d.tiered&&(d.listO="<"+d.options.tocListType+">",d.listC="</"+d.options.tocListType+">",d.listEO="<li>",d.listEC="</li>",d.toc+=d.listO+d.listEO),f="",!0===d.options.numbered&&(g=0,h={},i={},j="",k=""),d.$nodes.addClass(d.options.nodeClass).each(function(l,m){b=a(m),c=d.getLevel(b),d.tiered&&(e=d.currentLevel,0===l?(d.currentOriLevel=c,d.currentOriMinLevel=c):(c>d.currentOriLevel?(e=d.currentLevel+1,d.currentOriLevel=c):c<d.currentOriLevel&&(e=c<=d.currentOriMinLevel?0:c-d.currentOriMinLevel,d.currentOriLevel=c,c<d.currentOriMinLevel&&(d.currentOriMinLevel=c)),d.toc+=d.formatLevel(e,!1)),!0===d.options.numbered&&(!h[e]||e>g?h[e]=1:h[e]+=1,g===e?f=k+h[e]:(e>g?(k=j+d.options.numberedJoin,i[e]=k):k="",f=0===e?h[e]:i[e]+h[e]),j=f,f=d.options.numberedPrefix+f+d.options.numberedSuffix,g=e)),d.toc+=d.formatLink(b,c,f),d.tiered&&l+1===d.$nodes.length&&(d.toc+=d.formatLevel(e,!0)),d.currentLevel=e}),d.tiered&&(d.toc+=d.listEC+d.listC),a("body").data(d.options.nodeNumKey,d.nodeNum)},d.createToc=function(){var b,c,e,f,g;d.$target=a(d.options.tocTarget),d.$toc=a('<div class="er_toc_content"></div>').html(d.toc),d.$target.length||(d.$target=a("<div></div>").prependTo(d.$this)),d.options.tocClass&&d.$target.addClass(d.options.tocClass),d.$target.append(d.$toc),b=a.trim(d.options.tocTitle),b.length&&(c=a("<div></div>").html(b).append("<span></span>"),e=d.options.tocTitleClass.length,e&&c.addClass(d.options.tocTitleClass),!0===d.options.tocControl&&(f=e?d.options.tocTitleClass+"_open":"er_toc_title_open",g=e?d.options.tocTitleClass+"_close":"er_toc_title_close",c.css("cursor","pointer").click(function(){a(this).hasClass(f)?(a(this).removeClass(f).addClass(g),d.$toc.slideUp()):(a(this).removeClass(g).addClass(f),d.$toc.slideDown())}).click()),c.prependTo(d.$target)),d.options.tocScroll&&d.$toc.find("a").click(function(){return d.$body.animate({scrollTop:a(a(this).attr("href")).offset().top-d.options.goTopBaseHeight},d.options.scrollSpeed),!1})},d.addGoTop=function(){var b,c,f,g,h,i,j,e=!0===d.options.goTop?"Top":d.options.goTop;"all"===d.options.goTopNodes?c=d.$nodes:"auto"===d.options.goTopNodes?(g=[],h=0,i=d.getPositionToTop(d.$this),j=Math.round(d.$this.height()/d.$nodes.length),d.options.goTopDepth>j&&(j=d.options.goTopDepth),d.$nodes.each(function(b){f=a(this).position().top-h,0===b&&(f+=i),f>=j&&(g.push("#"+a(this).attr("id")),h=a(this).position().top)}),g.length&&(c=d.$nodes.filter(g.join(", ")))):c=d.$nodes.filter(d.options.goTopNodes),b=a('<a href="#" class="'+d.options.goTopClass+'" title="'+e+'">'+e+"</a>"),c.append(b),c.children("a."+d.options.goTopClass).click(function(){return d.$body.animate({scrollTop:d.$topNode.offset().top-d.options.goTopBaseHeight},d.options.scrollSpeed),!1})},d.getLevel=function(b){var c,e;if(d.nodes.ids.length&&(c=b.get(0).nodeName.toLowerCase(),a.inArray(c,d.nodes.ids)>=0))return d.nodes.sorts.ids[c];if(d.nodes.classes.length)for(e=0;e<d.nodes.classes.length;e++)if(c=d.nodes.classes[e],b.hasClass(c))return d.nodes.sorts.classes[c];return 0},d.tieredList=function(){var b=a.inArray(d.options.tocListType,["ul","ol"]);return 0>b?!1:!0},d.getPositionToTop=function(a){for(var c,b=0;a;){if(c=a.data("isGoTopPosition")&&"yes"===a.data("isGoTopPosition")?!0:!1){a=null;break}b+=a.position().top,a=a.parent()}return b},d.formatLink=function(a,b,c){var e=a.text(),f=a.attr("id")||d.options.nodeIdPrefix+d.nodeNum,g=d.tiered?"":' class="'+d.options.tocClassPrefix+b+'"';return a.attr("id",f),d.nodeNum++,c+'<a href="#'+f+'" title="'+e+'"'+g+">"+e+"</a>"},d.formatLevel=function(a,b){!0!==b&&(b=!1);var c=a>d.currentLevel?d.formatTag(d.currentLevel,a,!b):d.formatTag(a,d.currentLevel)+(!0===b?d.formatTag(0,d.currentLevel):d.listEC+d.listEO);return c},d.formatTag=function(a,b,c){var f,e=[];for(!0!==c&&(c=!1),f=a;b>f;f++)e.push(c?d.listO:d.listC);return c?e.join(d.listEO)+d.listEO:d.listEC+e.join(d.listEC)},d.init()},a.erToc.defaults={startLevel:"h1",maxLevel:"h6",nodes:["h1","h2","h3","h4","h5","h6"],nodeMin:0,nodeMax:0,nodeClass:"er_toc_tag",nodeIdPrefix:"er-toc-id-",tocTarget:"",tocClass:"er_toc",tocTitle:"Table of Contents",tocTitleClass:"er_toc_title",tocListType:"ul",tocControl:!0,tocClassPrefix:"er_toc_level_",tocScroll:!0,goTop:!0,goTopBaseHeight:0,goTopNodes:"auto",goTopDepth:450,goTopClass:"er_toc_top",goTopNode:"body",scrollSpeed:1e3,nodeNumKey:"erTocNodeNum",numbered:!0,numberedJoin:".",numberedPrefix:"",numberedSuffix:" "},a.fn.erToc=function(b){return this.each(function(){new a.erToc(this,b)})}}(jQuery);
